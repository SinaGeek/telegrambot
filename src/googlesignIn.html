<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sign in to Google Drive</title>
		<style>
			body {
				font-family: sans-serif;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
				background-color: #f4f4f4;
				text-align: center;
			}
			.container {
				background: white;
				padding: 2rem;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}
			input,
			button {
				width: 100%;
				padding: 0.8rem;
				margin-top: 1rem;
				box-sizing: border-box;
			}
			button {
				background-color: #007bff;
				color: white;
				border: none;
				cursor: pointer;
			}
			button:disabled {
				background-color: #ccc;
			}
			#status {
				margin-top: 1rem;
				font-weight: bold;
			}
			#auth-section {
				margin-bottom: 2rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h2>Sign in to Google Drive for Telegram Bot</h2>
			<div id="status">Processing...</div>
		</div>

		<script>
			const statusDiv = document.getElementById('status');
			const WORKER_URL = 'https://bot.turksafar.ir';
			const params = new URLSearchParams(window.location.search);
			const code = params.get('code');
			const state = params.get('state');

			async function postCode(authCode, userId) {
				try {
					const formData = new FormData();
					formData.append('authCode', authCode);
					formData.append('userId', userId);
					const resp = await fetch(`${WORKER_URL}/login`, { method: 'POST', body: formData });
					const result = await resp.json().catch(() => ({}));
					if (resp.ok) {
						statusDiv.textContent = 'Signed in successfully! Redirecting to Telegramâ€¦';
						statusDiv.style.color = 'green';
						// Redirect back to the Telegram bot so the user lands in chat again
						setTimeout(() => {
							window.location.href = 'https://t.me/WOWDriveBot?start=auth_done';
						}, 800);
					} else {
						throw new Error(result.error || 'Sign-in failed.');
					}
				} catch (e) {
					statusDiv.textContent = `Error: ${e.message}`;
					statusDiv.style.color = 'red';
				}
			}

			(async () => {
				if (code && state) {
					statusDiv.textContent = 'Exchanging code...';
					await postCode(code, state);
				} else {
					statusDiv.textContent = 'Missing authorization code. Please return to Telegram and use /login again.';
					statusDiv.style.color = 'red';
				}
			})();
		</script>
	</body>
</html>
