<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sign in to google drive</title>
		<style>
			body {
				font-family: sans-serif;
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
				background-color: #f4f4f4;
				text-align: center;
			}
			.container {
				background: white;
				padding: 2rem;
				border-radius: 8px;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
			}
			input,
			button {
				width: 100%;
				padding: 0.8rem;
				margin-top: 1rem;
				box-sizing: border-box;
			}
			button {
				background-color: #007bff;
				color: white;
				border: none;
				cursor: pointer;
			}
			button:disabled {
				background-color: #ccc;
			}
			#status {
				margin-top: 1rem;
				font-weight: bold;
			}
			#auth-section {
				margin-bottom: 2rem;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h2>Sign in to Google Drive for Telegram Bot</h2>

			<div id="auth-section">
				<p>Please sign in with Google to connect your Drive to the Telegram bot.</p>
				<button id="loginBtn">Sign in with Google</button>
			</div>

			<div id="status"></div>
		</div>

		<script src="https://accounts.google.com/gsi/client" async defer></script>

		<script>
			const statusDiv = document.getElementById('status');
			const loginBtn = document.getElementById('loginBtn');
			const authSection = document.getElementById('auth-section');

			// Completed TODO: Replace with your actual credentials and URLs
			const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com'; // Replace with actual
			const WORKER_URL = 'https://bot.turksafar.ir'; // Replace with your deployed worker URL

			let tokenClient;

			// Get userId from URL (passed from Telegram bot link)
			const urlParams = new URLSearchParams(window.location.search);
			const userId = urlParams.get('userId');
			if (!userId) {
				statusDiv.textContent = 'Error: No user ID provided. Please access this page from the Telegram bot.';
				statusDiv.style.color = 'red';
				loginBtn.disabled = true;
				return;
			}

			function initializeGsi() {
				tokenClient = google.accounts.oauth2.initCodeClient({
					client_id: GOOGLE_CLIENT_ID,
					scope: 'https://www.googleapis.com/auth/drive', // Updated for full Drive management
					ux_mode: 'popup',
					access_type: 'offline',
					callback: async (response) => {
						if (response.code) {
							console.log('Authorization code received.');
							statusDiv.textContent = 'Signing in...';
							statusDiv.style.color = 'blue';

							const formData = new FormData();
							formData.append('authCode', response.code);
							formData.append('userId', userId);

							try {
								const resp = await fetch(`${WORKER_URL}/login`, {
									method: 'POST',
									body: formData,
								});
								const result = await resp.json();
								if (resp.ok) {
									statusDiv.textContent = 'Signed in successfully! You can now return to Telegram.';
									statusDiv.style.color = 'green';
									authSection.style.display = 'none';
								} else {
									throw new Error(result.error || 'Sign-in failed.');
								}
							} catch (error) {
								statusDiv.textContent = `Error: ${error.message}`;
								statusDiv.style.color = 'red';
							}
						} else {
							statusDiv.textContent = 'Sign-in failed. Please try again.';
							statusDiv.style.color = 'red';
						}
					},
				});
			}

			loginBtn.onclick = () => {
				if (!tokenClient) {
					alert('Google client not ready. Please wait a moment and try again.');
					return;
				}
				tokenClient.requestCode();
			};

			// Load the Google client library
			window.onload = initializeGsi;
		</script>
	</body>
</html>
